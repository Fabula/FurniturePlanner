<?xml version="1.0" encoding="utf-8"?>
<s:VGroup xmlns:fx="http://ns.adobe.com/mxml/2009" 
		  xmlns:s="library://ns.adobe.com/flex/spark" 
		  xmlns:mx="library://ns.adobe.com/flex/mx"
		  horizontalCenter="0" verticalCenter="0"
		  width="100%" height="100%"
		  paddingTop="10" paddingRight="10" paddingBottom="10" paddingLeft="10"
		  creationComplete="creationCompleteHandler(event)"
		  currentState="DefaultAdminState">
	<fx:Script>
		<![CDATA[
			import components.Controllers.UsersController;
			import components.Models.Users;
			
			import mx.collections.ArrayCollection;
			import mx.collections.XMLListCollection;
			import mx.controls.Alert;
			import mx.events.FlexEvent;
			import mx.events.ListEvent;
			import mx.managers.CursorManager;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import spark.events.TextOperationEvent;
			
			private var model:Users;
			private var controller:UsersController;
									
			protected function creationCompleteHandler(event:FlexEvent):void
			{
				model = new Users();
				model.addEventListener(Event.CHANGE, this.updateUsersList);
				controller = new UsersController(model);
				controller.getUsersList();
			}
			
			protected function updateUsersList(event:Event):void{
				usersListDatagrid.dataProvider = model.getListOfUsers().children();
			}
			
			protected function usersListDatagrid_clickHandler(event:MouseEvent):void
			{
				controller.handleDataGridClickEvent(usersListDatagrid.selectedItem);
				this.currentState = "AdminStateWithChangeUserDataPanel";
				showCurrentUserData();
			}
						
			protected function createUserButton_clickHandler(event:MouseEvent):void
			{				
				controller.createNewUser(userLogin.text, userEmail.text, userName.text, userSurName.text, userTelephoneNumber.text,
											userCategoriesComboBox.selectedItem.data, userPassword.text, userPasswordConfirmation.text);
				clearCreateUserForm();
			}
			
			protected function changeUserDataButton_clickHandler(event:MouseEvent):void
			{
				controller.changeUserData(model.currentUser.id, loginTextInput.text, emailTextInput.text, nameTextInput.text, 
											surNameTextInput.text, telephoneNumberTextInput.text);
			}

			protected function destroyUserButton_clickHandler(event:MouseEvent):void
			{
				controller.deleteUser(model.currentUser.id);
			}
			
			protected function showCurrentUserData():void{
				nameTextInput.text = model.currentUser.name;
				surNameTextInput.text = model.currentUser.last_name;
				telephoneNumberTextInput.text = model.currentUser.telephone_number;
				emailTextInput.text = model.currentUser.email;
				loginTextInput.text = model.currentUser.login;
			} 
			
			protected function clearCreateUserForm():void{
				userLogin.text = "";
				userPassword.text = "";
				userPasswordConfirmation.text = "";
				userEmail.text = "";
				userSurName.text = "";
				userName.text = "";
				userTelephoneNumber.text = "";
			}

			protected function categoryChangedHandler(event:ListEvent):void
			{
				controller.handleUserCategoriesChange(usersCategoryList.selectedItem.data);
				if (usersCategoryList.selectedItem.data == "all"){
					usersListDatagrid.dataProvider = model.getListOfUsers().children();
				}
				else{
					usersListDatagrid.dataProvider = model.specificUsers;
				} 
			}

			protected function searchField_changeHandler(event:TextOperationEvent):void
			{
				controller.searchHandler(searchField.text);
				
				if (searchField.text !== ""){
					usersListDatagrid.dataProvider = model.requiredUsers;
				}
				else{
					usersListDatagrid.dataProvider = model.getListOfUsers().children();
				}
			} 
		]]>
	</fx:Script>
	<s:states>
		<s:State name="DefaultAdminState"/>
		<s:State name="AdminStateWithChangeUserDataPanel"/>
	</s:states>
	<s:transitions>
		<s:Transition fromState="DefaultAdminState" toState="AdminStateWithChangeUserDataPanel">
			<s:Sequence targets="{[changeUserDataPanel]}">
				<s:Wipe direction="down" duration="1000" />
			</s:Sequence>
		</s:Transition>
	</s:transitions>
<s:Scroller width="100%" height="100%">
	<s:Group width="100%" height="100%">
		<s:HGroup width="100%" height="100%">
			<s:Panel title="Добавить нового пользователя"
					 width="350">
				<mx:Form>
					<mx:FormItem label="Категория пользователя:">
						<mx:ComboBox id="userCategoriesComboBox"
									 dataProvider="{Users.categories}"/>
					</mx:FormItem>
					<mx:FormItem label="Имя пользователя: ">
						<s:TextInput id="userName"/>
					</mx:FormItem>
					<mx:FormItem label="Фамилия пользователя: ">
						<s:TextInput id="userSurName"/>
					</mx:FormItem>
					<mx:FormItem label="Номер телефона: ">
						<s:TextInput id="userTelephoneNumber" />
					</mx:FormItem>
					<mx:FormItem label="Электронная почта: ">
						<s:TextInput id="userEmail" />		
					</mx:FormItem>
					<mx:FormItem label="Логин: ">
						<s:TextInput id="userLogin"/>
					</mx:FormItem>
					<mx:FormItem label="Пароль: ">
						<s:TextInput id="userPassword" displayAsPassword="true"/>
					</mx:FormItem>
					<mx:FormItem label="Повторите пароль: ">
						<s:TextInput id="userPasswordConfirmation" displayAsPassword="true" />
					</mx:FormItem>
					<mx:FormItem>
						<s:Button label="Создать" 
								  id="createUserButton"
								  click="createUserButton_clickHandler(event)" />
					</mx:FormItem>
				</mx:Form>
			</s:Panel>
			<s:VGroup width="100%" height="100%"
					  minWidth="570">
				<s:Panel title="Пользователи системы"
						 width="100%" height="100%"
						 minHeight="300">
					<s:VGroup width="100%" height="100%"
							  gap="10"
							  paddingBottom="10" paddingTop="10" paddingRight="10" paddingLeft="10">
						<s:HGroup width="100%">
							<s:Group height="100%">
								<s:Label text="Поиск:" top="5"/>
							</s:Group>
							<s:VGroup width="100%">
								<s:TextInput id="searchField"
											 change="searchField_changeHandler(event)"
											 width="100%" />
								<mx:Label text='&quot;Например: Орлов&quot; ' 
										 fontSize="10" />
							</s:VGroup>
						</s:HGroup>
						<s:HGroup width="100%"
								  verticalAlign="middle">
							<s:Label text="Пользователи категории:" />
							<mx:ComboBox id="usersCategoryList"
										 dataProvider="{Users.userCategories}"
										 change="categoryChangedHandler(event)"/>
						</s:HGroup>
						<mx:DataGrid
							id="usersListDatagrid"
							height="100%" width="100%"
							paddingLeft="10" paddingRight="10" paddingBottom="10"
							click="usersListDatagrid_clickHandler(event)">
							<mx:columns>
								<mx:DataGridColumn headerText="Имя" dataField="name"/>
								<mx:DataGridColumn headerText="Фамилия" dataField="last_name"/>
								<mx:DataGridColumn headerText="Номер телефона" dataField="telephone_number"/>
								<mx:DataGridColumn headerText="Тип учетной записи" dataField="system_role" />
								<mx:DataGridColumn headerText="Логин" dataField="login"/>
							</mx:columns>
						</mx:DataGrid>
					</s:VGroup>
				</s:Panel>
				<s:Panel id="changeUserDataPanel"
						 title="Изменить данные пользователя"
						 width="100%" 
						 includeIn="AdminStateWithChangeUserDataPanel">
					<s:controlBarContent>
						<s:HGroup width="100%"
								  horizontalAlign="center">
							<s:Button label="Изменить данные пользователя" 
									  id="changeUserDataButton"
									  click="changeUserDataButton_clickHandler(event)"/>
							<s:Button id="destroyUserButton"
									  label="Удалить пользователя"
									  click="destroyUserButton_clickHandler(event)"/>
						</s:HGroup>
					</s:controlBarContent>
					<s:VGroup
						horizontalAlign="center"
						width="100%" height="100%">
						<s:HGroup height="100%">
							<mx:Form>
								<mx:FormHeading label="Персональные данные" />
								<mx:FormItem label="Имя:">
									<s:TextInput id="nameTextInput"  />
								</mx:FormItem>
								<mx:FormItem label="Фамилия:">
									<s:TextInput id="surNameTextInput"/>
								</mx:FormItem>
								<mx:FormItem label="Номер телефона:">
									<s:TextInput id="telephoneNumberTextInput" />
								</mx:FormItem>
								<mx:FormItem label="Электронная почта:">
									<s:TextInput id="emailTextInput"/>
								</mx:FormItem>
							</mx:Form>
							<mx:Form>
								<mx:FormHeading label="Логин/пароль" />
								<mx:FormItem label="Логин:">
									<s:TextInput id="loginTextInput" enabled="false"/>
								</mx:FormItem>
								<mx:FormItem label="Пароль:">
									<s:TextInput id="passwordTextInput"/>
								</mx:FormItem>
								<mx:FormItem label="Повторите пароль:">
									<s:TextInput id="passwordConfirmationTextInput"/>
								</mx:FormItem>
							</mx:Form>
						</s:HGroup>
					</s:VGroup>
				</s:Panel>
			</s:VGroup>
		</s:HGroup>
	</s:Group>
</s:Scroller>
</s:VGroup>